<!DOCTYPE html>
<html>
<head>

<style type="text/css"> 
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 5px }
  #googleMap { height: 90%; margin: 5px }
  input { margin: 3px }
</style> 


<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDadqq4rG3XNyc7HZZYrw8GH4CsFcV49bk&sensor=false">
</script>

<script type="text/javascript">
var map;
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var tolerance; //remap if route is too short or too long
var counter = 0; //number of remaps because of UTurns
var LatLng1;
var LatLng2;
var LatLng3;
var movedPt;

  

function initialize() {
  directionsDisplay = new google.maps.DirectionsRenderer({draggable:true});
  var mapProp = {
    center: new google.maps.LatLng(42.3736158, -71.109733),
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.ROADMAP
    };
  map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
  directionsDisplay.setMap(map);
  google.maps.event.addListener(directionsDisplay, 'directions_changed', calcDist);
}

function submit() {
  movedPt = false;
  counter = 0;
  tolerance = 0.1;
  var geocoder=new google.maps.Geocoder();
  var location=document.getElementById("location").value;
  var GeoReq={ address:location };
  geocoder.geocode(GeoReq, function (results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var LatLng=results[0].geometry.location;
      map.setCenter(LatLng);
      findPts(LatLng);
      plotRoute();
      }
    else {
      alert("Geocoding was unsuccessful because: " + status);
      }
    });
}

function findPts(LatLng) {
  LatLng1 = LatLng; //can't do this above because can't modify global variables in anonymous function
  var Lat1 = LatLng1.lat()*Math.PI/180; //LatLong in degrees; trig in radians
  var Long1 = LatLng1.lng()*Math.PI/180;
  var dist = document.getElementById("distance").value;
  var phi = Math.PI/180*document.getElementById("phi").value; //angle between leg1 and leg3
  var scale = 0.8; //straitline_distance/actual_distance
  var legDist = scale*dist/(2+2*Math.sin(phi/2));
  var r = 4000*Math.cos(Lat1); //horizontal radius at given latitude
  var theta = 2*Math.random()*Math.PI;
  var Lat2 = legDist*Math.cos(theta)/4000+Lat1;
  var Long2 = Long1+legDist*Math.sin(theta)/r;
  var Lat3 = legDist*Math.cos(theta+phi)/4000+Lat1;
  var Long3 = Long1+legDist*Math.sin(theta+phi)/r;
  LatLng2 = new google.maps.LatLng(Lat2*180/Math.PI, Long2*180/Math.PI);
  LatLng3 = new google.maps.LatLng(Lat3*180/Math.PI, Long3*180/Math.PI);
}

function plotRoute() {
  var request = {
    origin: LatLng1,
    destination: LatLng1,
    waypoints: [
      {
        location: LatLng2,
        stopover: false
      },
      {
        location: LatLng3,
        stopover: false
      }],
    travelMode: google.maps.TravelMode.BICYCLING,
    avoidHighways: true,
    optimizeWaypoints: true
    };
  directionsService.route(request, function(result, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      var routeDistFt = result.routes[0].legs[0].distance.value;
      var distFt = 1609 * document.getElementById("distance").value; //convert to ft
      if (Math.abs(routeDistFt-distFt)/distFt > tolerance) {
        tolerance *= 1.1; //increase tolerance to ensure eventually will get route
        findPts(LatLng1);
        plotRoute();
      }
      else {
        var routeDist = result.routes[0].legs[0].distance.text;
        document.getElementById("routeDistance").innerHTML = routeDist;
      }
      if (movedPt==false) {
        movePtToRd(result);
        movedPt = true;
        plotRoute();
      }
      if (counter>10) {
        document.getElementById("allowUTurns").checked=true;
        alert("Unable to find a route without U-Turns after 10 attempts.\n"
          +"To keep trying, deselect [Allow U-Turns] and press [map] again.\n");
      }
      else if (hasUTurn(result)&&!(document.getElementById("allowUTurns").checked)) {
        moveUTurn(result);
        tolerance *= 1.1; //increase tolerance to ensure eventually will get route
        counter += 1;
        plotRoute();
      }
      directionsDisplay.setDirections(result);
    }
  });
}


function showDirections() {
  var openWindow = window.open("", "", "width=400, height=600");
  var steps = directionsDisplay.directions.routes[0].legs[0].steps;
  var uniqueSteps = [];
  for (var i=0; i<steps.length; i++) {
    if (steps[i].instructions != uniqueSteps[uniqueSteps.length]
        && steps[i].instructions.split(" ").length>2
        && steps[i].instructions.indexOf('bicycle')==-1) {
      uniqueSteps.push(steps[i].instructions+": "+steps[i].distance.text);
    }
  }
  openWindow.document.write(uniqueSteps.join("<br>"));
  var routeDist = document.getElementById("routeDistance").innerHTML;
  openWindow.document.write("<br><br>Total: "+routeDist);
  openWindow.focus();
}

function moveUTurn(result) {
  var newWaypt = findGoodLatLng(result);
  //var marker = new google.maps.Marker({position:newWaypt, map:map, title:"hi"});
  // no sqrt below b/c x^2>y^2 -> x>y
  var dist2 = Math.pow(LatLng2.lat()-newWaypt.lat(),2)+Math.pow(LatLng2.lng()-newWaypt.lng(),2);
  var dist3 = Math.pow(LatLng3.lat()-newWaypt.lat(),2)+Math.pow(LatLng3.lng()-newWaypt.lng(),2);
  if (dist2<dist3) {
    LatLng2 = newWaypt;
  }
  else {
    LatLng3 = newWaypt;
  }
}

function hasUTurn(result) {
  var ok = false;
  var steps = result.routes[0].legs[0].steps;
  for (var i=0; i<steps.length; i++) {
    if (steps[i].instructions.indexOf("U-turn") != -1) {
      ok=true;
      break;
    }
  }
  return ok;
}

function findGoodLatLng(result) {
  var steps = result.routes[0].legs[0].steps;
  for (var i=0; i<steps.length; i++) {
    if (steps[i].instructions.indexOf("U-turn") != -1) {
      return steps[i-2].start_location;
      break;
    }
  }
}

function movePtToRd(result) {
  var steps = result.routes[0].legs[0].steps;
  var minDist1 = 10; //actually dist^2
  var minDist2 = 10;
  var bestStep1;
  var bestStep2;
  for (var i=0; i<steps.length; i++) {
    var dist1 = Math.pow(LatLng2.lat()-steps[i].start_location.lat(),2)
                +Math.pow(LatLng2.lng()-steps[i].start_location.lng(),2);
    var dist2 = Math.pow(LatLng3.lat()-steps[i].start_location.lat(),2)
                +Math.pow(LatLng3.lng()-steps[i].start_location.lng(),2);
    if (dist1 < minDist1) {
      bestStep1 = i;
    }
    if (dist2 < minDist2) {
      bestStep2 = i;
    }
  }
  LatLng2 = steps[bestStep1-1].start_location;
  LatLng3 = steps[bestStep2-1].start_location;
}


  
google.maps.event.addDomListener(window, 'load', initialize);


</script>
</head>

<body>
<div id="header" style="height:8%">

<iframe src="http://ghbtns.com/github-btn.html?user=ben-eysenbach&repo=run_map&type=fork&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="90" height="40" style="position:absolute; right: 10px"></iframe>

<div>
Location<input id="location" style="width:300px" type="textbox" value="Cambridge, MA">
Distance (mi)<input id="distance" style="width:50px" type="number" min=0 value=5>
Angle<input id="phi" style="width:50px" type="number" min=0 max=180 value=60>
<input type="button" value="map" onclick="submit()"></div>
<div>
Allow U-Turns<input id="allowUTurns" type="checkbox">
Route Distance: <span id="routeDistance"></span>
<input style="position:absolute; right:10px" type="button" value="show directions" onclick="showDirections()">
</div>
</div>


<div id="googleMap"></div>

</body>
</html>
